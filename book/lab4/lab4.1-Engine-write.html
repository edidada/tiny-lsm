<!DOCTYPE HTML>
<html lang="zh-CN" class="navy sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Lab 4.1 Engine 的写入 - Toni-LSM-Lab</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "navy";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('navy')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Toni-LSM-Lab</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ToniXWD/toni-lsm" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/ToniXWD/toni-lsm/edit/lab-doc/src/lab4/lab4.1-Engine-write.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="lab-41-engine-的写入"><a class="header" href="#lab-41-engine-的写入">Lab 4.1 Engine 的写入</a></h1>
<h1 id="1-概述"><a class="header" href="#1-概述">1 概述</a></h1>
<p>与之前的模块不同, <code>LSMEngine</code>部分我们不打算按照<code>CRUD</code>迭代器的顺序进行实验, 因为其<code>Put</code>操作包含了<code>SST</code>的构建流程, 而<code>Get</code>操作是对已经构建的<code>SST</code>进行查询, 因此, 本章的<code>Lab</code>以<code>SST</code>的生命周期为线索, 逐步实现<code>Lab</code>, 这样的设计也有助于你对上层组件运行调度机制的理解。</p>
<p>话不多说，我们先来看看<code>Engine</code>的头文件定义, 然后结合理论知识, 介绍<code>put</code>流程和<code>sst</code>的构建流程</p>
<pre><code class="language-cpp">class Level_Iterator;

class LSMEngine : public std::enable_shared_from_this&lt;LSMEngine&gt; {
public:
  std::string data_dir;
  MemTable memtable;
  std::map&lt;size_t, std::deque&lt;size_t&gt;&gt; level_sst_ids;
  std::unordered_map&lt;size_t, std::shared_ptr&lt;SST&gt;&gt; ssts;
  std::shared_mutex ssts_mtx;
  std::shared_ptr&lt;BlockCache&gt; block_cache;
  size_t next_sst_id = 0; // 下一个要分配的 sst id
  size_t cur_max_level = 0; // 当前最大的 level
};

class LSM {
private:
  std::shared_ptr&lt;LSMEngine&gt; engine;
  std::shared_ptr&lt;TranManager&gt; tran_manager_; // 本Lab不需要关注
};
</code></pre>
<p>这里, 我们使用了<code>LSM</code>包裹了<code>LSMEngine</code>, <code>LSMEngine</code>是你要补全函数实现的类, 其中定义了<code>memtable</code>, <code>level_sst_ids</code>, <code>ssts</code>, <code>block_cache</code>, <code>next_sst_id</code>, <code>cur_max_level</code>等成员变量。这里比较重要的包括:</p>
<ul>
<li><code>level_sst_ids</code>: 从<code>level</code>到这一层的<code>sst_id</code>数组, 每一个<code>SST</code>由一个<code>sst_id</code>唯一表示</li>
<li><code>ssts</code>: <code>sst_id</code>到<code>SST</code>的映射</li>
<li><code>next_sst_id</code>: <code>SST</code>的<code>id</code>分配器, <code>LSMEngine</code>在<code>flush</code>形成行的<code>SST</code>时, 会分配一个<code>sst_id</code>给<code>SST</code>, 然后将<code>sst_id</code>和<code>SST</code>映射关系存入<code>ssts</code>中, <code>next_sst_id</code>就是<code>sst_id</code>的分配器, 每次分配<code>sst_id</code>时, <code>next_sst_id</code>都会自增1</li>
<li><code>cur_max_level</code>: 顾名思义, 就是当前<code>SST</code>的最大的<code>level</code></li>
<li><code>data_dir</code>: <code>LSMEngine</code>的<code>data_dir</code>, 即数据文件的存储位置, 这个参数我们在单元测试中会进行指定, <code>SST</code>文件需要存放在这个目录下</li>
<li><code>MemTable</code>: 即整个<code>LSM Tree</code>引擎的内存表部分</li>
</ul>
<p>剩下的成员变量:</p>
<ul>
<li><code>ssts_mtx</code>: 全局的<code>sst文件</code>的访问锁, 这里是一个读写锁, 当然这个变量不是必须的, 你可以按照自己的理解实现并发控制策略(不过建议使用这个变量)</li>
<li><code>block_cache</code>: 全局的缓存池指针, 你实现缓存池之前, 默认其为<code>nullptr</code>即可</li>
</ul>
<blockquote>
<p>这里的<code>l0_sst_ids</code>记录了所有<code>sst</code>的<code>id</code>, 其排序是从大到小, 因为<code>sst</code>的<code>id</code>越大表示这个<code>sst</code>越新, 需要优先查询。</p>
<p>可以使用<code>l0_sst_ids</code>获取的<code>id</code>从哈希表<code>ssts</code>中查询<code>SST</code>的描述类(类似于文件描述符)。</p>
</blockquote>
<h1 id="2-写入删除流程"><a class="header" href="#2-写入删除流程">2 写入/删除流程</a></h1>
<p>结合刚刚对类的成员变量定义的简单介绍, 我们再次回顾一下<code>LSM Tree</code>的读写流程:</p>
<ol>
<li>写入<code>MemTable</code>:
<ol>
<li>如果写入的<code>KV</code>的<code>value</code>为空, 表示一个删除标记</li>
<li>直接调用成员变量<code>memtable</code>的接口即可</li>
<li>同样有批量接口和单次操作的接口</li>
</ol>
</li>
<li>若当前活跃的<code>MemTable</code>大小达到阈值, 则将其冻结
<ol>
<li>这一部分已经在<code>MemTable</code>中实现, 你无需再实现</li>
</ol>
</li>
<li>若冻结的<code>MemTable</code>容量达到阈值, 则将最早冻结的<code>MemTable</code>转为<code>SST</code>
<ol>
<li>判断<code>MemTable</code>容量并决定是否刷盘是你需要在本小节<code>Lab</code>进行实现的内容之一</li>
<li><code>SST</code>文件的设计是每一层的<code>SST文件</code>数量不能超过指定阈值, 因此你刷盘的<code>Level 0</code>的<code>SST</code>文件可能会哦触发<code>Level 0</code>和<code>Level 1</code>的<code>SST</code>文件的<code>compact</code>, 不过这一任务没有放在<code>Lab 4.1</code>, <code>Lab4.1</code>中你当做就只有<code>Level 0</code>这一个层级即可</li>
</ol>
</li>
</ol>
<p>因此, 本小节<code>Lab</code>的核心就是整合之前创建的<code>MemTable</code>, <code>SST</code>, <code>Block</code>, <code>Iterator</code>, 并调用接口实现对外服务的功能</p>
<h1 id="3-代码实现"><a class="header" href="#3-代码实现">3 代码实现</a></h1>
<p>本小节你需要更改的代码文件为:</p>
<ul>
<li><code>src/lsm/engine.cpp</code></li>
<li><code>include/lsm/engine.h</code></li>
</ul>
<h2 id="31-put--remove"><a class="header" href="#31-put--remove">3.1 Put &amp;&amp; Remove</a></h2>
<p>你首先需要实现<code>put</code>函数, <code>put</code>函数肯定是操纵<code>memtable</code>成员变量, 另外你也需要根据其容量接口函数判断什么时候需要进行<code>flush</code>操作:</p>
<pre><code class="language-cpp">uint64_t LSMEngine::put(const std::string &amp;key, const std::string &amp;value,
                        uint64_t tranc_id) {
  // TODO: Lab 4.1 插入
  // ? 由于 put 操作可能触发 flush
  // ? 如果触发了 flush 则返回新刷盘的 sst 的 id
  // ? 在没有实现  flush 的情况下，你返回 0即可
  return 0;
}
uint64_t LSMEngine::remove(const std::string &amp;key, uint64_t tranc_id) {
  // TODO: Lab 4.1 删除
  // ? 在 LSM 中，删除实际上是插入一个空值
  // ? 由于 put 操作可能触发 flush
  // ? 如果触发了 flush 则返回新刷盘的 sst 的 id
  // ? 在没有实现  flush 的情况下，你返回 0即可
  return 0;
}
</code></pre>
<p>这个函数的最终版本需要调用<code>flush</code>进行刷盘, 因此建议你将次函数和后面的<code>flush</code>函数一起实现。</p>
<p>此时你仍然可以忽略<code>tranc_id</code>, 将其传递到接口的参数即可。至于返回值<code>uint64_t</code>, 你现阶段返回0即可。</p>
<blockquote>
<p>额外说明, 这里说明一下为什么返回值是<code>uint64_t</code>，而不是<code>void</code>, 这主要是为后续的事务准备的, 刷盘意味着事务操作的持久化完成, 因此需要更新已经成功持久化的最大事务<code>id</code>, 也就是这里的返回值。如果你现在看不懂也没关系, 到实现事务的<code>Lab</code>就明白了。</p>
</blockquote>
<p>根据之前部分描述, 此时你可以简化刷盘部分的逻辑, 即默认现在只有<code>Level 0</code>的<code>SST文件</code>, <code>SST文件</code>不会进行<code>Compact</code>形成新的<code>Level</code></p>
<h2 id="32-put_batch--remove_batch"><a class="header" href="#32-put_batch--remove_batch">3.2 put_batch &amp;&amp; remove_batch</a></h2>
<p>和<code>put/remove</code>函数的逻辑几乎一样, 只是写入时是批量数据:</p>
<pre><code class="language-cpp">uint64_t LSMEngine::put_batch(
    const std::vector&lt;std::pair&lt;std::string, std::string&gt;&gt; &amp;kvs,
    uint64_t tranc_id) {
  // TODO: Lab 4.1 批量插入
  // ? 由于 put 操作可能触发 flush
  // ? 如果触发了 flush 则返回新刷盘的 sst 的 id
  // ? 在没有实现  flush 的情况下，你返回 0即可
  return 0;
}

uint64_t LSMEngine::remove_batch(const std::vector&lt;std::string&gt; &amp;keys,
                                 uint64_t tranc_id) {
  // TODO: Lab 4.1 批量删除
  // ? 在 LSM 中，删除实际上是插入一个空值
  // ? 由于 put 操作可能触发 flush
  // ? 如果触发了 flush 则返回新刷盘的 sst 的 id
  // ? 在没有实现  flush 的情况下，你返回 0即可
  return 0;
}
</code></pre>
<h2 id="33-flush"><a class="header" href="#33-flush">3.3 Flush</a></h2>
<p><code>flush</code>函数会将<code>MemTable</code>中<code>frozen_tables</code>中最旧的一个跳表的数据刷盘，并返回刷盘过程中提取的统计信息<code>tranc_id</code>, 现阶段你只需要返回0即可。</p>
<blockquote>
<p><strong>Hint</strong>:
<code>flush()</code>的返回值是和<code>put()</code>等接口的返回值一致的</p>
</blockquote>
<pre><code class="language-cpp">uint64_t LSMEngine::flush() {
  // TODO: Lab 4.1 刷盘形成sst文件
  return 0;
}
</code></pre>
<p><code>flush</code>函数应该是这一小节的关键函数了, 这里的逻辑就是从<code>memtable</code>的接口将最旧的跳表刷盘城<code>SST</code>文件, 这里涉及到文件<code>IO</code>的操作时, 推荐使用作者定义好的辅助类<code>FileObj</code>, 其定义在<code>include/utils/files.h</code>中, 如果你有兴趣, 也可以看看``include/utils`中定义的其他工具类及其实现。</p>
<p>最后，<code>SST文件</code>的命名格式已经在<code>get_sst_path</code>中进行了详细的说明:</p>
<pre><code class="language-cpp">std::string LSMEngine::get_sst_path(size_t sst_id, size_t target_level) {
  // sst的文件路径格式为: data_dir/sst_&lt;sst_id&gt;.&lt;level&gt;，sst_id格式化为32位数字
  std::stringstream ss;
  ss &lt;&lt; data_dir &lt;&lt; "/sst_" &lt;&lt; std::setfill('0') &lt;&lt; std::setw(32) &lt;&lt; sst_id
     &lt;&lt; '.' &lt;&lt; target_level;
  return ss.str();
}
</code></pre>
<blockquote>
<p>后缀标记了这个<code>SST文件</code>所属的<code>Level</code>, 在你实现<code>Compact</code>前, 这个后缀设置为0即可</p>
</blockquote>
<p><strong>你必须严格遵守<code>SST</code>文件格式的命名规范, 如果你采用自己的文件命名方式, 那么请自行修改对应的单元测试函数(非常不推荐)。</strong></p>
<h1 id="4-测试"><a class="header" href="#4-测试">4 测试</a></h1>
<p>由于我们目前仅实现了写入模块, 测试函数无法从引擎读取数据, 因此本小节没有单元测试, 当你实现<a href="./lab4.2-Engine-read.html">Lab 4.2 Engine 的读取</a>后会进行统一的单元测试。</p>
<h1 id="5-思考"><a class="header" href="#5-思考">5 思考</a></h1>
<p>现在请先思考一下几个问题，然后开启<a href="./lab4.2-Engine-read.html">Lab 4.2 Engine 的读取</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../lab4/Engine-Base.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../lab4/lab4.2-Engine-read.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../lab4/Engine-Base.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../lab4/lab4.2-Engine-read.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src=".././src/giscus.js"></script>


    </div>
    </body>
</html>
